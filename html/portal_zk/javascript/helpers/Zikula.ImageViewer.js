// Copyright Zikula Foundation 2010 - license GNU/LGPLv3 (or at your option, any later version).
if(typeof(Zikula)=="undefined"){Zikula={}}Zikula.ImageViewerUtil=Class.create({initialize:function(){this.setup();document.observe("dom:loaded",this.postInit.bind(this))},postInit:function(){this.galleries=new Hash();this.galleries.set("list",$$("a[rel^=lightbox], a[rel^=imageviewer]").pluck("rel").uniq());$$("a[rel^=lightbox], a[rel^=imageviewer]").invoke("observe","click",this.initViewer.bindAsEventListener(this))},setup:function(a){this.config=Object.extend({speed:1,draggable:true,caption:true,pager:true,modal:true,enablekeys:true,scaleImage:true,scaleFactor:0.85,langLabels:{}},a||{});this.config.langLabels=Object.extend({close:Zikula.__("Close"),next:Zikula.__("Next"),prev:Zikula.__("Prev"),pager:Zikula.__("Image #{index} of #{total}")},this.config.langLabels);this.config.langLabels.pager=new Template(this.config.langLabels.pager)},initViewer:function(a){a.stop();if(this.started){return}this.started=true;this.element=a.findElement("a");this.referer=this.element.down("img")?this.element.down("img"):this.element;this.isnew=true;this.isGallery=false;if(this.element.rel!="lightbox"&&this.element.rel!="imageviewer"){if(!this.galleries.get(this.element.rel)){this.galleries.set(this.element.rel,$$('a[rel="'+this.element.rel+'"]').collect(function(b){return b.identify()}))}this.gallerySize=this.galleries.get(this.element.rel).length;this.isGallery=this.gallerySize>1}this.prepareBox()},prepareBox:function(a){a=Object.isUndefined(a)?false:true;this.updateBox(a);this.imgPreloader=new Image();this.imgPreloader.onload=this.showBox.bindAsEventListener(this);this.imgPreloader.src=this.element.readAttribute("href")},showBox:function(){if(this.config.modal){this.ImageViewerOverlay.appear({to:0.7,duration:this.config.speed/2})}this.ImageViewerImg.src=this.element.readAttribute("href");this.ImageViewerImg.width=this.imgPreloader.width;this.ImageViewerImg.height=this.imgPreloader.height;var d=document.viewport.getDimensions();if(this.config.scaleImage){var k=this.imgPreloader.width/d.width,f=this.imgPreloader.height/d.height;if(k>f){var g=Math.round(d.width*this.config.scaleFactor);this.ImageViewerImg.setStyle({maxWidth:g+"px",maxHeight:Math.round((g/this.imgPreloader.width)*this.imgPreloader.height)+"px"})}else{var b=Math.round(d.height*this.config.scaleFactor);this.ImageViewerImg.setStyle({maxHeight:b+"px",maxWidth:Math.round((b/this.imgPreloader.height)*this.imgPreloader.width)+"px"})}}if(this.config.caption){this.ImageViewerTitle.update(this.element.readAttribute("title")||"&nbsp;").show();this.ImageViewerFooter.setStyle({width:this.ImageViewerImg.width-this.offset.footerWidth+this.offset.boxWidth+"px",height:"auto"})}if(this.config.pager&&this.isGallery){this.ImageViewerPager.update(this.pagerInfo()).show()}var e={width:this.offset.boxWidth+this.ImageViewerImg.width,height:this.offset.boxHeight+this.ImageViewerImg.height+this.ImageViewerFooter.getHeight()};if(this.isnew){this.imageBox.setStyle({overflow:"hidden",opacity:0.5})}var i=Math.floor((d.height/2)-(e.height/2)+document.viewport.getScrollOffsets().top),j=Math.floor((d.width/2)-(e.width/2)),c=-(this.referer.cumulativeOffset().left-j),a=-(this.referer.cumulativeOffset().top-i);if(this.isnew){new Effect.Parallel([new Effect.Appear(this.imageBox,{from:0.5,to:1,sync:true}),new Effect.Move(this.imageBox,{x:c,y:a,sync:true}),new Effect.Morph(this.imageBox,{style:{width:e.width+"px",height:e.height+"px"},sync:true})],{duration:this.config.speed,afterFinish:this.finishBox.bind(this)})}else{new Effect.Morph(this.imageBox,{style:{left:j+"px",top:i+"px",width:e.width+"px",height:e.height+"px"},duration:this.config.speed,afterFinish:this.finishBox.bind(this)})}},finishBox:function(){this.ImageViewerImg.appear({from:0,to:1,duration:this.config.speed/2,afterSetup:function(){this.imageBox.removeClassName("loading").setStyle({overflow:"visible"})}.bind(this)});if(this.config.draggable){if(this.isGallery&&this.config.caption){this.drag=new Draggable(this.imageBox,{handle:this.ImageViewerFooter})}else{this.drag=new Draggable(this.imageBox)}}this.started=false;if(this.isGallery){this.preloadAdjacentImages()}},clickBox:function(a){a.stop();if(this.imageBox.visible()){if(a.element()==$("ImageViewerPrev")){this.moveBox("prev",a)}else{if(a.element()==$("ImageViewerNext")){this.moveBox("next",a)}else{if(a.element()==$("ImageViewerClose")){this.hideBox(a)}}}}},key:function(a){if(this.imageBox.visible()&&a.keyCode){switch(a.keyCode){case Event.KEY_LEFT:this.moveBox("prev",a);break;case Event.KEY_RIGHT:this.moveBox("next",a);break;case Event.KEY_ESC:this.hideBox(a);break}}},hideBox:function(a){if(!a||!a.isRightClick()){this.imageBox.fade({duration:this.config.speed/4});if(this.config.modal){this.ImageViewerOverlay.fade({duration:this.config.speed/2})}if(this.drag&&this.drag.destroy){this.drag.destroy()}if(this.imgPreloader&&this.imgPreloader.onload){this.imgPreloader.onload=null;this.started=false}}},moveBox:function(a,c){if(!this.isGallery){return}c.stop();var d=a=="prev"?-1:1,b=this.galleries.get(this.element.rel)[this.index+d];if(b){this.element=$(b);this.referer=this.imageBox;this.isnew=false;this.prepareBox(true)}},pagerInfo:function(){return this.config.langLabels.pager.evaluate({index:this.index+1,total:this.gallerySize})},buildBox:function(){this.endBind=this.hideBox.bindAsEventListener(this);this.keyBind=this.key.bindAsEventListener(this);if(this.config.modal){this.ImageViewerOverlay=new Element("div",{id:"ImageViewerOverlay"}).setStyle({opacity:0.9,display:"none"});$(document.body).insert(this.ImageViewerOverlay);this.ImageViewerOverlay.observe("click",this.endBind)}this.imageBox=new Element("div",{id:"ImageViewer"});$(document.body).insert(this.imageBox);this.ImageViewerClose=new Element("span",{id:"ImageViewerClose",title:this.config.langLabels.close});this.imageBox.insert(this.ImageViewerClose);this.ImageViewerImgContainer=new Element("div",{id:"ImageViewerImgContainer"});this.ImageViewerImg=new Element("img",{id:"ImageViewerImg",src:this.element.readAttribute("href")});this.ImageViewerPrev=new Element("a",{id:"ImageViewerPrev",title:this.config.langLabels.prev}).hide();this.ImageViewerNext=new Element("a",{id:"ImageViewerNext",title:this.config.langLabels.next}).hide();this.imageBox.insert(this.ImageViewerImgContainer.insert(this.ImageViewerImg).insert(this.ImageViewerPrev).insert(this.ImageViewerNext));if(this.config.pager||this.config.caption){this.ImageViewerFooter=new Element("p",{id:"ImageViewerFooter"});this.ImageViewerFooter.addClassName("z-clearfix");if(this.config.caption){this.ImageViewerTitle=new Element("span",{id:"ImageViewerTitle"}).hide()}if(this.config.pager){this.ImageViewerPager=new Element("span",{id:"ImageViewerPager"}).hide()}this.imageBox.insert(this.ImageViewerFooter.insert(this.ImageViewerTitle).insert(this.ImageViewerPager))}var b=this.imageBox.getLayout(),c=this.ImageViewerImg.getLayout(),a=this.ImageViewerFooter.getLayout();this.offset={boxWidth:b.get("width")-c.get("width"),boxHeight:b.get("height")-c.get("height")-a.get("margin-box-height"),paddingWidth:b.get("margin-box-width")-b.get("width"),paddingHeight:b.get("margin-box-height")-b.get("height"),footerWidth:a.get("margin-box-width")-a.get("width")};this.imageBox.observe("click",this.clickBox.bindAsEventListener(this));document.observe("click",this.endBind);if(this.config.enablekeys){document.observe("keydown",this.keyBind)}},updateBox:function(b){if(!this.imageBox){this.buildBox()}if(!b||this.isnew){var a=this.referer.getLayout();this.imageBox.setStyle({overflow:"hidden",opacity:0.5,position:"absolute",width:a.get("width")-this.offset.paddingWidth+"px",height:a.get("height")-this.offset.paddingHeight+"px",left:this.referer.cumulativeOffset()[0]+"px",top:this.referer.cumulativeOffset()[1]+"px"});this.imageBox.show()}if(this.drag&&this.drag.destroy){this.drag.destroy()}this.imageBox.className="";this.imageBox.addClassName("loading");if(this.ImageViewerPager){this.ImageViewerPager.hide()}this.ImageViewerPrev.hide();this.ImageViewerNext.hide();if(this.isGallery){this.index=this.galleries.get(this.element.rel).indexOf(this.element.identify());if(this.index==0){this.imageBox.addClassName("first")}else{this.ImageViewerPrev.show()}if(this.index+1==this.gallerySize){this.imageBox.addClassName("last")}else{this.ImageViewerNext.show()}this.imageBox.addClassName("gallery")}},preloadAdjacentImages:function(){var b,a;if(this.index>0){b=new Image();b.src=$(this.galleries.get(this.element.rel)[this.index-1]).href}if(this.index+1<this.gallerySize){a=new Image();a.src=$(this.galleries.get(this.element.rel)[this.index+1]).href}}});Zikula.ImageViewer=new Zikula.ImageViewerUtil();