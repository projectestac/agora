// Copyright Zikula Foundation 2010 - license GNU/LGPLv3 (or at your option, any later version).
Zikula.define("AdminPanel");Zikula.AdminPanel.labels={clickToEdit:Zikula.__("Right-click down arrows to edit tab name"),edit:Zikula.__("Edit category"),remove:Zikula.__("Delete category"),makeDefault:Zikula.__("Make default category"),saving:Zikula.__("Saving")};Zikula.AdminPanel.setupNotices=function(){var c={headerSelector:"strong",headerClassName:"z-systemnoticeheader z-panel-indicator",effectDuration:0.5},d=$$("#z-developernotices ul:first");if($("z-securityanalyzer")){c.active=[0]}Zikula.AdminPanel.noticesPanels=new Zikula.UI.Panels("admin-systemnotices",c);if(d[0]){d[0].removeClassName("z-hide")}};Zikula.AdminPanel.Tab=Class.create({initialize:function(c,d){if(d){this.tab=this.createTab(d)}else{this.tab=$(c)}this.id=/admintab_(\d+)/.exec(this.tab.identify())[1];this.attachActionsMenu();this.attachModulesMenu();this.attachEditor();Droppables.add(this.tab.down("a"),{accept:"draggable",hoverclass:"ajaxhover",onDrop:function(b,a){Zikula.AdminPanel.Module.getModule(b).move(a)}});this.tab.store("tab",this)},createTab:function(h){var e=new Element("a",{href:h.url}).update(h.name),g=new Element("span",{"class":"z-admindrop"}).update("&nbsp;"),f=new Element("li",{id:"admintab_"+h.id,"class":"admintab",style:"z-index: 0"}).insert(e).insert(g);$("addcat").insert({before:f});return f},attachActionsMenu:function(){var e=this.tab.down("span"),f=new Zikula.UI.ContextMenu(e,{animation:false}),d=this;f.addItem({label:Zikula.AdminPanel.labels.edit,callback:function(a){d.editor.enterEditMode()}});f.addItem({label:Zikula.AdminPanel.labels.remove,callback:function(a){d.deleteTab()}});f.addItem({label:Zikula.AdminPanel.labels.makeDefault,callback:function(a){d.setTabDefault()}});this.actionsMenu=f},attachModulesMenu:function(){var d=this.tab.down("span"),e=Zikula.AdminPanel.Tab.menusData[this.id]?Zikula.AdminPanel.Tab.menusData[this.id].items:[],f=new Zikula.UI.ContextMenu(d,{leftClick:true,animation:false});e.each(function(a){f.addItem({label:a.menutext,moduleId:a.id,callback:function(){window.location=a.menutexturl}})});this.modulesMenu=f},attachEditor:function(){var d=this.tab.down("a"),c=this;this.editor=new Ajax.InPlaceEditor(d,"ajax.php?module=Admin&type=ajax&func=editCategory",{clickToEditText:Zikula.AdminPanel.labels.clickToEdit,savingText:Zikula.AdminPanel.labels.saving,externalControl:"admintabs-none",externalControlOnly:true,rows:1,cols:d.innerHTML.length,submitOnBlur:true,okControl:false,cancelControl:false,ajaxOptions:Zikula.Ajax.Request.defaultOptions(),onFormCustomization:function(b,a){$(a).observe("keypress",function(f){if(f.keyCode===Event.KEY_RETURN){f.stop();f.element().blur()}})},onEnterEditMode:function(b,a){c.originalText=d.innerHTML},callback:function(b,a){return{name:a,cid:c.id}},onComplete:function(a,f){a=Zikula.Ajax.Response.extend(a);if(!a.isSuccess()){d.update(c.originalText);Zikula.showajaxerror(a.getMessage());return}var b=a.getData();d.update(b.response)}})},deleteTab:function(){var b={cid:this.id};new Zikula.Ajax.Request("ajax.php?module=Admin&type=ajax&func=deleteCategory",{parameters:b,onComplete:this.deleteTabResponse.bind(this)})},deleteTabResponse:function(b){if(!b.isSuccess()){Zikula.showajaxerror(b.getMessage());return}this.tab.remove();Zikula.AdminPanel.Tab.removeTab(this.id)},setTabDefault:function(){var b={cid:this.id};new Zikula.Ajax.Request("ajax.php?module=Admin&type=ajax&func=defaultCategory",{parameters:b,onComplete:this.setTabDefaultResponse.bind(this)})},setTabDefaultResponse:function(b){if(!b.isSuccess()){Zikula.showajaxerror(b.getMessage())}}});Object.extend(Zikula.AdminPanel.Tab,{tabs:{},menusData:{},getTab:function(d){d=$(d);var c;if(d.nodeName==="LI"&&d.hasClassName("admintab")){c=d}else{c=d.up("li.admintab")}return c?$(c).retrieve("tab"):null},removeTab:function(b){delete this.tabs[b];this.setupSortable()},init:function(){this.menusData=$("admintabs-menuoptions").getValue().unescapeHTML().evalJSON();this.setupSortable();var b=function(a){a.preventDefault();a.element().stopObserving("click",b)};Draggables.addObserver({onStart:function(f,a,e){if(a.element.down("a")!=undefined){a.element.down("a").stopObserving("click",b);setTimeout(function(){a.element.down("a").observe("click",b)},200)}}});$("admintabs").select("li.admintab").each(function(d){var a=new Zikula.AdminPanel.Tab(d);this.tabs[a.id]=a}.bind(this));this.setupForm()},setupSortable:function(){Sortable.destroy("admintabs");Sortable.create("admintabs",{tag:"li",constraint:"horizontal",onUpdate:function(c){var d=Sortable.serialize("admintabs");new Zikula.Ajax.Request("ajax.php?module=Admin&type=ajax&func=sortCategories",{parameters:d,onComplete:function(a){if(!a.isSuccess()){Zikula.showajaxerror(a.getMessage())}}})},only:["admintab","active"]})},setupForm:function(){this.addTabLink=$("addcatlink");this.addTabForm=$("ajaxNewCatHidden").removeClassName("z-hide").hide();this.addTabLink.observe("click",this.addTabShowForm.bindAsEventListener(this));this.addTabForm.down("form").observe("submit",this.addTabSave.bindAsEventListener(this));this.addTabForm.down("a.cancel").observe("click",this.addTabHideForm.bindAsEventListener(this));this.addTabForm.down("a.save").observe("click",this.addTabSave.bindAsEventListener(this));return this},addTabShowForm:function(b){if(b){b.stop()}this.addTabLink.hide();this.addTabForm.show();return this},addTabHideForm:function(b){if(b){b.stop()}this.addTabLink.show();this.addTabForm.hide().down("form").reset();return this},addTabSave:function(f){f.stop();var e=this.addTabForm.down("[name=name]").getValue();if(e===""){Zikula.showajaxerror(Zikula.__("You must enter a name for the new category"));return this}this.addTabHideForm();var d={name:e};new Zikula.Ajax.Request("ajax.php?module=Admin&type=ajax&func=addCategory",{parameters:d,onComplete:this.addTabResponse.bind(this)});return this},addTabResponse:function(e){if(!e.isSuccess()){Zikula.showajaxerror(e.getMessage());this.addTabHideForm();return this}var d=e.getData(),f=new Zikula.AdminPanel.Tab(null,d);this.tabs[f.id]=f;Zikula.AdminPanel.Tab.setupSortable();return this}});Zikula.AdminPanel.Module=Class.create({initialize:function(b){this.module=$(b);this.id=(/module_(\d+)/).exec($(this.module).identify())[1];this.attachMenu();this.module.store("module",this)},attachMenu:function(){var d=this.module.down("input.modlinks").getValue().unescapeHTML().evalJSON()||[],c;if(d.size()>0){c=new Zikula.UI.ContextMenu(this.module.down(".module-context"),{leftClick:true,animation:false});d.each(function(a){c.addItem({label:a.text,callback:function(){window.location=a.url}})});this.menu=c}},move:function(c){var d={modid:this.id,cat:Zikula.AdminPanel.Tab.getTab(c).id};new Zikula.Ajax.Request("ajax.php?module=Admin&type=ajax&func=changeModuleCategory",{parameters:d,onComplete:this.moveResponse.bind(this)})},moveResponse:function(d){if(!d.isSuccess()){Zikula.showajaxerror(d.getMessage());return}var f=d.getData();if(f.parentCategory==f.oldCategory){return this}Zikula.AdminPanel.Tab.tabs[f.parentCategory].modulesMenu.addItem({label:f.name,moduleId:f.id,callback:function(){window.location=f.url}});var e=Zikula.AdminPanel.Tab.tabs[f.oldCategory].modulesMenu.items;e.each(function(a,b){if(a.moduleId==f.id){e.splice(b,1)}});this.module.remove();Zikula.AdminPanel.Module.removeModule(this.id)}});Object.extend(Zikula.AdminPanel.Module,{modules:{},getModule:function(b){return $(b).retrieve("module")},removeModule:function(b){delete this.modules[b];this.setupSortable()},init:function(){this.setupSortable();$$(".z-adminiconcontainer").each(function(c){var d=new Zikula.AdminPanel.Module(c);this.modules[d.id]=d}.bind(this))},setupSortable:function(){if($$(".z-adminiconcontainer").size()===0){return}Sortable.destroy("modules");Sortable.create("modules",{tag:"div",constraint:"",only:["z-adminiconcontainer"],handle:"z-dragicon",onUpdate:function(c){var d=Sortable.serialize("modules");new Zikula.Ajax.Request("ajax.php?module=Admin&type=ajax&func=sortModules",{parameters:d,onComplete:function(a){if(!a.isSuccess()){Zikula.showajaxerror(a.getMessage())}}})}})}});Zikula.AdminPanel.init=function(){Zikula.AdminPanel.setupNotices();Zikula.AdminPanel.Tab.init();Zikula.AdminPanel.Module.init()};document.observe("dom:loaded",Zikula.AdminPanel.init);