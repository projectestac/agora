// Copyright Zikula Foundation 2010 - license GNU/LGPLv3 (or at your option, any later version).
Zikula.define("Categories");Event.observe(window,"load",function(){Zikula.TreeSortable.trees.categoriesTree.config.onSave=Zikula.Categories.Resequence;$("catExpand").observe("click",function(a){a.preventDefault();Zikula.TreeSortable.trees.categoriesTree.expandAll()});$("catCollapse").observe("click",function(a){a.preventDefault();Zikula.TreeSortable.trees.categoriesTree.collapseAll()});Zikula.UI.Tooltips($$(".tree a"));Zikula.Categories.AttachMenu()});Zikula.Categories.AttachMenu=function(){Zikula.Categories.ContextMenu=new Zikula.UI.ContextMenu(Zikula.TreeSortable.trees.categoriesTree.tree,{animation:false,beforeOpen:function(a){Zikula.Categories.ContextMenu.lastClick=a;if(!a.findElement("a")){throw $break}}});Zikula.Categories.ContextMenu.addItem({label:Zikula.__("Edit"),callback:function(a){Zikula.Categories.MenuAction(a,"edit")}});Zikula.Categories.ContextMenu.addItem({label:Zikula.__("Delete"),callback:function(a){Zikula.Categories.DeleteMenuAction(a)}});Zikula.Categories.ContextMenu.addItem({label:Zikula.__("Copy"),callback:function(a){Zikula.Categories.MenuAction(a,"copy")}});Zikula.Categories.ContextMenu.addItem({label:Zikula.__("Activate"),condition:function(){return Zikula.Categories.ContextMenu.lastClick.findElement("a").hasClassName(Zikula.TreeSortable.trees.categoriesTree.config.nodeUnactive)},callback:function(a){Zikula.Categories.MenuAction(a,"activate")}});Zikula.Categories.ContextMenu.addItem({label:Zikula.__("Deactivate"),condition:function(){return !Zikula.Categories.ContextMenu.lastClick.findElement("a").hasClassName(Zikula.TreeSortable.trees.categoriesTree.config.nodeUnactive)},callback:function(a){Zikula.Categories.MenuAction(a,"deactivate")}});Zikula.Categories.ContextMenu.addItem({label:Zikula.__("Add category (after selected)"),callback:function(a){Zikula.Categories.MenuAction(a,"addafter")}});Zikula.Categories.ContextMenu.addItem({label:Zikula.__("Add subcategory (into selected)"),condition:function(){return !Zikula.Categories.ContextMenu.lastClick.findElement("a").up("li").hasClassName("leaf")},callback:function(a){Zikula.Categories.MenuAction(a,"addchild")}})};Zikula.Categories.Indicator=function(){return $("ajax_indicator")?$("ajax_indicator"):new Element("img",{id:"ajax_indicator",src:"images/ajax/indicator_circle.gif"})};Zikula.Categories.DeleteMenuAction=function(b){var c=Zikula.Categories.ContextMenu.lastClick.findElement("a").up("li").down("ul"),e=new Element("div",{id:"dialogContent"}).insert(new Element("p").update(Zikula.__("Do you really want to delete this category?"))),a=[{name:"Delete",value:"Delete",label:Zikula.__("Delete"),"class":"z-btgreen"},{name:"Cancel",value:"Cancel",label:Zikula.__("Cancel"),"class":"z-btred"},];c=c?c.childElements().size():0;if(c>0){var d=Zikula.__f("It contains %s direct sub-categories.",c)+" "+Zikula.__("Please also choose what to do with this category's sub-categories.");e.insert(new Element("p",{"class":"z-informationmsg"}).update(d));a=[{name:"Delete",value:"Delete",label:Zikula.__("Delete all sub-categories"),"class":"z-btgreen"},{name:"Delete",value:"DeleteAndMoveSubs",label:Zikula.__("Move all sub-categories"),"class":"z-btgreen",close:false},{name:"Cancel",value:"Cancel",label:Zikula.__("Cancel"),"class":"z-btred"},]}Zikula.Categories.DeleteDialog=new Zikula.UI.Dialog(e,a,{title:Zikula.__("Confirmation prompt"),width:500,callback:function(f){switch(f.value){case"Delete":Zikula.Categories.MenuAction(b,"delete");Zikula.Categories.DeleteDialog.destroy();break;case"DeleteAndMoveSubs":if(!$("subcat_move")){$("dialogContent").addClassName("z-form");Zikula.Categories.DeleteDialog.window.indicator.appear({to:0.7,duration:0.2});new Zikula.Ajax.Request("ajax.php?module=Categories&func=deletedialog",{parameters:{cid:Zikula.TreeSortable.trees.categoriesTree.getNodeId(b.up("li"))},onComplete:function(i){var h=i.getData().result;$("dialogContent").insert(h);Zikula.Categories.DeleteDialog.container.morph("height:250px");Zikula.Categories.DeleteDialog.window.indicator.fade({duration:0.2})}})}else{var g=$F("category_parent_id_");if(g){Zikula.Categories.MenuAction(b,"deleteandmovesubs",g);Zikula.Categories.DeleteDialog.destroy()}}break;default:Zikula.Categories.DeleteDialog.destroy()}}});Zikula.Categories.DeleteDialog.open();Zikula.Categories.DeleteDialog.container.down("button[name=Cancel]").focus()};Zikula.Categories.MenuAction=function(c,d,e){if(!["edit","delete","deleteandmovesubs","copy","activate","deactivate","addafter","addchild"].include(d)){return false}c.insert({after:Zikula.Categories.Indicator()});var a="ajax.php?module=Categories&func=",b={cid:Zikula.TreeSortable.trees.categoriesTree.getNodeId(c.up("li"))};switch(d){case"edit":b.mode="edit";break;case"deleteandmovesubs":b.parent=e;break;case"copy":b.parent=Zikula.TreeSortable.trees.categoriesTree.getNodeId(c.up("li").up("li"));break;case"addafter":b.mode="new";b.parent=Zikula.TreeSortable.trees.categoriesTree.getNodeId(c.up("li").up("li"));d="edit";break;case"addchild":b.mode="new";b.parent=Zikula.TreeSortable.trees.categoriesTree.getNodeId(c.up("li"));d="edit";break}a=a+d;new Zikula.Ajax.Request(a,{parameters:b,onComplete:Zikula.Categories.MenuActionCallback});return true};Zikula.Categories.MenuActionCallback=function(d){if(!d.isSuccess()){Zikula.showajaxerror(d.getMessage());return false}var e=d.getData(),c=$(Zikula.TreeSortable.trees.categoriesTree.config.nodePrefix+e.cid);switch(e.action){case"delete":Droppables.remove(c);c.select("li").each(function(f){Droppables.remove(f)});Effect.SwitchOff(c,{afterFinish:function(){c.remove()}});Zikula.TreeSortable.trees.categoriesTree.drawNodes();break;case"deleteandmovesubs":Droppables.remove(c);c.select("li").each(function(f){Droppables.remove(f)});Effect.SwitchOff(c,{afterFinish:function(){c.remove()}});var b=Zikula.TreeSortable.trees.categoriesTree.config.nodePrefix+e.parent;$(b).replace(e.node);Zikula.Categories.ReinitTreeNode($(b),e);break;case"activate":c.down("a").removeClassName(Zikula.TreeSortable.trees.categoriesTree.config.nodeUnactive);break;case"deactivate":c.down("a").addClassName(Zikula.TreeSortable.trees.categoriesTree.config.nodeUnactive);break;case"copy":var a=Zikula.TreeSortable.trees.categoriesTree.config.nodePrefix+e.copycid;$(a).replace(e.node);Zikula.Categories.ReinitTreeNode($(a),e);break;case"edit":$(document.body).insert(e.result);Zikula.Categories.OpenForm(e,Zikula.Categories.EditNode);break;case"add":$(document.body).insert(e.result);Zikula.Categories.OpenForm(e,Zikula.Categories.AddNode);break}return true};Zikula.Categories.OpenForm=function(a,b){if(Zikula.Categories.Form){Zikula.Categories.Form.destroy()}Zikula.Categories.Form=new Zikula.UI.FormDialog($("categories_ajax_form_container"),b,{title:$("categories_ajax_form_container").title,width:700,afterOpen:Zikula.Categories.InitEditView,buttons:[{label:Zikula.__("Submit"),type:"submit",name:"submit",value:"submit","class":"z-btgreen",close:false},{label:Zikula.__("Cancel"),type:"submit",name:"cancel",value:false,"class":"z-btred",close:true}]});return Zikula.Categories.Form.open()};Zikula.Categories.CloseForm=function(){Zikula.Categories.Form.destroy();Zikula.Categories.Form=null};Zikula.Categories.UpdateForm=function(a){$("categories_ajax_form_container").replace(a);Zikula.Categories.Form.window.indicator.fade({duration:0.2});$("categories_ajax_form_container").show();Zikula.Categories.InitEditView()};Zikula.Categories.EditNode=function(b){if(!b||(b.hasOwnProperty("cancel")&&b.cancel===false)){Zikula.Categories.CloseForm();return false}Zikula.Categories.Form.window.indicator.appear({to:0.7,duration:0.2});var a=Zikula.Categories.Form.serialize(true);a.mode="edit";new Zikula.Ajax.Request("ajax.php?module=Categories&func=save",{parameters:a,onComplete:function(c){var d=c.getData();if(!c.isSuccess()||d.validationErrors){Zikula.showajaxerror(c.getMessage());if(d&&d.validationErrors){Zikula.Categories.UpdateForm(d.result)}else{Zikula.Categories.CloseForm()}}else{var e=Zikula.TreeSortable.trees.categoriesTree.config.nodePrefix+d.cid;$(e).replace(d.node);Zikula.Categories.ReinitTreeNode($(e),d);Zikula.Categories.CloseForm()}}});return true};Zikula.Categories.AddNode=function(b){if(!b||(b.hasOwnProperty("cancel")&&b.cancel===false)){Zikula.Categories.CloseForm();return false}Zikula.Categories.Form.window.indicator.appear({to:0.7,duration:0.2});var a=Zikula.Categories.Form.serialize(true);a.mode="new";new Zikula.Ajax.Request("ajax.php?module=Categories&func=save",{parameters:a,onComplete:function(f){var g=f.getData();if(!f.isSuccess()||g.validationErrors){Zikula.showajaxerror(f.getMessage());if(g&&g.validationErrors){Zikula.Categories.UpdateForm(g.result)}else{Zikula.Categories.CloseForm()}}else{var c=$(Zikula.TreeSortable.trees.categoriesTree.config.nodePrefix+g.parent),e=c.down("ul");if(!e){e=new Element(("ul"),{"class":"tree"});c.insert(e)}e.insert(g.node);var d=$(Zikula.TreeSortable.trees.categoriesTree.config.nodePrefix+g.cid);Zikula.Categories.ReinitTreeNode(d,g);Zikula.Categories.CloseForm()}}});return true};Zikula.Categories.ReinitTreeNode=function(b,c){Zikula.TreeSortable.trees.categoriesTree.initNode(b);var a=b.select("li");if(a){a.each(Zikula.TreeSortable.trees.categoriesTree.initNode.bind(Zikula.TreeSortable.trees.categoriesTree))}Zikula.TreeSortable.trees.categoriesTree.drawNodes();if(c.leafstatus){if(c.leafstatus.leaf){Zikula.TreeSortable.trees.categoriesTree.config.disabledForDrop=Zikula.TreeSortable.trees.categoriesTree.config.disabledForDrop.concat(c.leafstatus.leaf)}if(c.leafstatus.noleaf){Zikula.TreeSortable.trees.categoriesTree.config.disabledForDrop=[].without.apply(Zikula.TreeSortable.trees.categoriesTree.config.disabledForDrop,c.leafstatus.noleaf)}}Zikula.UI.Tooltips(b.select("a"))};Zikula.Categories.Resequence=function(c,e,d){if(c.up("li")===undefined){return false}var a={data:d};c.insert({bottom:Zikula.Categories.Indicator()});var b=new Zikula.Ajax.Request("ajax.php?module=Categories&func=resequence",{parameters:a,onComplete:Zikula.Categories.ResequenceCallback});return b.success()};Zikula.Categories.ResequenceCallback=function(a){if(!a.isSuccess()){Zikula.showajaxerror(a.getMessage());return Zikula.TreeSortable.categoriesTree.revertInsertion()}return true};