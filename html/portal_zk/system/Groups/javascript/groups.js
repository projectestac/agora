// Copyright Zikula Foundation 2010 - license GNU/LGPLv3 (or at your option, any later version).
var adding=Array();function groupinit(c,b,a){defaultgroup=c;firstgroup=b;admingroup=a;deleteiconhtml=$("groupeditdelete_"+firstgroup).innerHTML;canceliconhtml=$("groupeditcancel_"+firstgroup).innerHTML;appending=false;$("appendajax").removeClassName("z-hide");$$("button.z-imagebutton").each(function(e){var d=e.id.split("_")[1];switch(e.id.split("_")[0]){case"groupeditsave":$("groupeditsave_"+d).observe("click",function(){groupmodify(d)});break;case"groupeditdelete":$("groupeditdelete_"+d).observe("click",function(){groupdelete(d)});break;case"groupeditcancel":$("groupeditcancel_"+d).observe("click",function(){groupmodifycancel(d)});break}})}function groupappend(){if(appending==false){appending=true;new Zikula.Ajax.Request("ajax.php?module=Groups&func=creategroup",{onComplete:groupappend_response})}}function groupappend_response(b){appending=false;if(!b.isSuccess()){Zikula.showajaxerror(b.getMessage());return}var c=b.getData();var a=$("group_"+firstgroup).cloneNode(true);a.id="group_"+c.gid;$A(a.getElementsByTagName("a")).each(function(d){d.id=d.id.split("_")[0]+"_"+c.gid});$A(a.getElementsByTagName("div")).each(function(d){d.id=d.id.split("_")[0]+"_"+c.gid});$A(a.getElementsByTagName("span")).each(function(d){d.id=d.id.split("_")[0]+"_"+c.gid});$A(a.getElementsByTagName("input")).each(function(d){d.id=d.id.split("_")[0]+"_"+c.gid;d.value=""});$A(a.getElementsByTagName("select")).each(function(d){d.id=d.id.split("_")[0]+"_"+c.gid});$A(a.getElementsByTagName("button")).each(function(d){d.id=d.id.split("_")[0]+"_"+c.gid});$A(a.getElementsByTagName("textarea")).each(function(d){d.id=d.id.split("_")[0]+"_"+c.gid});$("grouplist").appendChild(a);$("name_"+c.gid).value=c.name;$("description_"+c.gid).value=c.description;$("editgroupnbumax_"+c.gid).value=c.nbumax;$("members_"+c.gid).href=c.membersurl;Zikula.setselectoption("state_"+c.gid,c.statelbl);Zikula.setselectoption("gtype_"+c.gid,c.gtypelbl);$("groupnbuser_"+c.gid).update(c.nbuser);$("groupnbumax_"+c.gid).update(c.nbumax);$("groupgid_"+c.gid).update(c.gid);$("groupname_"+c.gid).update(c.name);$("groupgtype_"+c.gid).update(c.gtypelbl);$("groupdescription_"+c.gid).update(c.description+"&nbsp;");$("groupstate_"+c.gid).update(c.statelbl);$("modifyajax_"+c.gid).observe("click",function(){groupmodifyinit(c.gid)});$("groupeditsave_"+c.gid).observe("click",function(){groupmodify(c.gid)});$("groupeditdelete_"+c.gid).observe("click",function(){groupdelete(c.gid)});$("groupeditcancel_"+c.gid).observe("click",function(){groupmodifycancel(c.gid)});$("modifyajax_"+c.gid).removeClassName("z-hide");$("modifyajax_"+c.gid).observe("click",function(){groupmodifyinit(c.gid)});enableeditfields(c.gid);$("group_"+c.gid).removeClassName("z-hide");new Effect.Highlight("group_"+c.gid,{startcolor:"#ffff99",endcolor:"#ffffff"});adding[c.gid]=1}function groupmodifyinit(a){if(getmodifystatus(a)==0){Zikula.setselectoption("gtype_"+a,$F("gtype_"+a));Zikula.setselectoption("state_"+a,$F("state_"+a));if((a==defaultgroup)||(a==admingroup)){$("groupeditdelete_"+a).addClassName("z-hide")}else{$("groupeditdelete_"+a).removeClassName("z-hide")}enableeditfields(a)}}function enableeditfields(a){$("groupname_"+a).addClassName("z-hide");$("groupgtype_"+a).addClassName("z-hide");$("groupdescription_"+a).addClassName("z-hide");$("groupstate_"+a).addClassName("z-hide");$("groupnbumax_"+a).addClassName("z-hide");$("groupaction_"+a).addClassName("z-hide");$("editgroupname_"+a).removeClassName("z-hide");$("editgroupgtype_"+a).removeClassName("z-hide");$("editgroupdescription_"+a).removeClassName("z-hide");$("editgroupstate_"+a).removeClassName("z-hide");$("editgroupnbumax_"+a).removeClassName("z-hide");$("editgroupaction_"+a).removeClassName("z-hide")}function disableeditfields(a){$("editgroupname_"+a).addClassName("z-hide");$("editgroupgtype_"+a).addClassName("z-hide");$("editgroupdescription_"+a).addClassName("z-hide");$("editgroupstate_"+a).addClassName("z-hide");$("editgroupnbumax_"+a).addClassName("z-hide");$("editgroupaction_"+a).addClassName("z-hide");$("groupname_"+a).removeClassName("z-hide");$("groupgtype_"+a).removeClassName("z-hide");$("groupdescription_"+a).removeClassName("z-hide");$("groupstate_"+a).removeClassName("z-hide");$("groupnbumax_"+a).removeClassName("z-hide");$("groupaction_"+a).removeClassName("z-hide")}function groupmodifycancel(a){if(adding[a]==1){groupdelete(a);adding=adding.without(a);return}disableeditfields(a);setmodifystatus(a,0)}function getmodifystatus(a){return $F("modifystatus_"+a)}function setmodifystatus(b,a){$("modifystatus_"+b).value=a}function groupmodify(a){disableeditfields(a);if(getmodifystatus(a)==0){setmodifystatus(a,1);showinfo(a,updatinggroup);var b={gid:a,name:$F("name_"+a),gtype:$F("gtype_"+a),description:$F("description_"+a),state:$F("state_"+a),nbumax:$F("nbumax_"+a)};new Zikula.Ajax.Request("ajax.php?module=Groups&func=updategroup",{parameters:b,onComplete:groupmodify_response,onFailure:function(){groupfailure_response(a)}})}}function groupmodify_response(a){if(!a.isSuccess()){showinfo();Zikula.showajaxerror(a.getMessage());return}var b=a.getData();if(b.error==1){showinfo();$("groupinfo_"+b.gid).addClassName("z-hide");$("groupcontent_"+b.gid).removeClassName("z-hide");Zikula.showajaxerror(b.message);setmodifystatus(b.gid,0);groupmodifyinit(b.gid);return}$("gtype_"+b.gid).value=b.gtype;$("state_"+b.gid).value=b.state;$("groupgtype_"+b.gid).update(b.gtypelbl);$("groupname_"+b.gid).update(b.name);$("groupdescription_"+b.gid).update(b.description+"&nbsp;");$("groupstate_"+b.gid).update(b.statelbl);$("groupnbuser_"+b.gid).update(b.nbuser);$("groupnbumax_"+b.gid).update(b.nbumax);adding=adding.without(b.gid);$("groupeditcancel_"+b.gid).removeClassName("z-hide");$("groupeditdelete_"+b.gid).update(deleteiconhtml);setmodifystatus(b.gid,0);showinfo(b.gid)}function groupdelete(a){if(confirm(confirmDeleteGroup)&&getmodifystatus(a)==0){showinfo(a,deletinggroup);setmodifystatus(a,1);var b={gid:a};new Zikula.Ajax.Request("ajax.php?module=Groups&func=deletegroup",{parameters:b,onComplete:groupdelete_response,onFailure:function(){groupfailure_response(a)}})}}function groupdelete_response(a){if(!a.isSuccess()){Zikula.showajaxerror(a.getMessage());return}var b=a.getData();setmodifystatus(b.gid,0);$("group_"+b.gid).remove()}function groupfailure_response(a){showinfo(a);disableeditfields(a);setmodifystatus(a,0)}function showinfo(b,a){if(b){var c=$("groupinfo_"+b);var d=$("groupcontent_"+b);if(!c.hasClassName("z-hide")){c.update("&nbsp;");c.addClassName("z-hide");d.removeClassName("z-hide")}else{c.update(a);d.addClassName("z-hide");c.removeClassName("z-hide")}}else{$A(document.getElementsByClassName("z-groupinfo")).each(function(e){$(e).update("&nbsp;");$(e).addClassName("z-hide")});$A(document.getElementsByClassName("groupcontent")).each(function(e){$(e).removeClassName("z-hide")})}}function groupremoveuser(d){d.preventDefault();var c=d.findElement("a"),a=c.readAttribute("rel").split(":"),b={gid:a[0],uid:a[1]};new Zikula.Ajax.Request("ajax.php?module=Groups&func=removeuser",{parameters:b,onComplete:groupremoveuser_response})}function groupremoveuser_response(c){if(!c.isSuccess()){Zikula.showajaxerror(c.getMessage());return}var a=c.getData().uid,b=$("user-"+a);if(b){var d=b.up("tr");Effect.SwitchOff(d,{afterFinish:function(){d.remove()}})}}$(document).observe("dom:loaded",function(){var a=$$("a.group-membership-removeuser");if(a){a.invoke("observe","click",groupremoveuser)}});