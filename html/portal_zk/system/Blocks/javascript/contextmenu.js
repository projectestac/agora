// Copyright Zikula Foundation 2010 - license GNU/LGPLv3 (or at your option, any later version).
var ContextMenu=Class.create({initialize:function(){this.config=Object.extend({objs:"",trigger:"click",menuId:"ContextMenu",menuClassName:"ContextMenu",subMenuClassName:"more",showMenuClassName:"show",disabledClassName:"disabled",activeClassName:"isfocused",menuOffset:10,menuTopAlign:-3,menuLeftAlign:["100%","-100%"],imagesDir:"",actionBaseHref:"",actionName:"action",actionArgs:"",dynamic:false,items:{}},arguments[0]||{});this.ie6=false
/*@cc_on || @_jscript_version < 5.7 @*/
;this.showMenuBind=this.showMenu.bindAsEventListener(this);this.hideMenuBind=this.hideMenu.bindAsEventListener(this);this.toggleNodeBind=this.toggleNode.bindAsEventListener(this);this.clickNodeBind=this.clickNode.bindAsEventListener(this);this.actionBind=this.action.bind(this);this.observe()},observe:function(){if(this.config.trigger=="contextmenu"){$$(this.config.objs).invoke("observe",Prototype.Browser.Opera?"click":"contextmenu",this.showMenuBind)}else{$$(this.config.objs).invoke("observe",this.config.trigger,this.showMenuBind)}},add:function(a){if(this.config.trigger=="contextmenu"){$(a).observe(Prototype.Browser.Opera?"click":"contextmenu",this.showMenuBind)}else{$(a).observe(this.config.trigger,this.showMenuBind)}},destroy:function(){if(this.config.trigger=="contextmenu"){$$(this.config.objs).invoke("stopObserving",Prototype.Browser.Opera?"click":"contextmenu",this.showMenuBind)}else{$$(this.config.objs).invoke("stopObserving",this.config.trigger,this.showMenuBind)}},buildMenu:function(a){if(this.menu){this.menu.remove()}this.menu=new Element("div",{id:this.config.menuId,className:this.config.menuClassName}).hide();if(this.ie6){this.iframe=new Element("iframe",{style:"position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);",src:"javascript:false;",frameborder:0});this.menu.insert(this.iframe)}var b=this.config.items.constructor===Function?this.config.items(a):this.config.items;var d=new Element("ul");for(var c in b){d.insert(this.buildItem(b[c]))}this.menu.insert(d);$(document.body).insert(this.menu)},buildItem:function(d){var a;if(d===true){a=new Element("li",{className:"separator"})}else{if(d.action&&d.action.constructor===Object){a=new Element("li",{className:d.disabled?this.config.disabledClassName:this.config.subMenuClassName}).insert(new Element("span",{title:d.title?d.title:null}).appendText(d.displayname?d.displayname:d.name).setStyle(d.img?{backgroundImage:'url("'+this.config.imagesDir+d.img+'")'}:{})).observe("click",this.clickNodeBind);var c=new Element("ul");if(this.ie6){c.insert($(this.iframe.cloneNode()))}for(var b in d.action){c.insert(this.buildItem(d.action[b]))}a.insert(c)}else{a=Object.extend(new Element("li",{className:d.disabled?this.config.disabledClassName:null}),{_action:d.action?d.action:this.actionBind,_confirm:d.confirm?d.confirm:false,_name:d.name}).insert(new Element("span",{title:d.title?d.title:null}).setStyle(d.img?{backgroundImage:'url("'+this.config.imagesDir+d.img+'")'}:{}).appendText(d.displayname?d.displayname:d.name).observe("click",this.clickNodeBind)).observe("click",this.clickNodeBind)}}return a},clickNode:function(a){a.stop();a.li=a.element().tagName=="LI"?a.element():a.element().up("li");if(!a.li.hasClassName(this.config.disabledClassName)){if(a.li.hasClassName(this.config.subMenuClassName)){this.toggleNode(a)}else{this.hideMenu();if(!a.li._confirm||confirm(a.li._confirm)){a.li._action(this.event,a)}}}},toggleNode:function(c){c.stop();c.ul=c.li.down("ul");if(c.ul.hasClassName(this.config.showMenuClassName)){c.li.select("ul").invoke("removeClassName",this.config.showMenuClassName)}else{var e=c.li.ancestors();this.menu.select("ul").select(function(h){return !e.include(h)}).invoke("removeClassName",this.config.showMenuClassName);var d=c.ul.getDimensions(),f={x:c.li.cumulativeOffset()[0]+c.li.getWidth(),y:c.li.cumulativeOffset()[1]},b=document.viewport.getDimensions(),a=document.viewport.getScrollOffsets(),g={left:((f.x+d.width+this.config.menuOffset)>b.width)?this.config.menuLeftAlign[1]:this.config.menuLeftAlign[0],top:(((f.y-a.top+d.height)>b.height)?(((f.y-a.top+d.height)-b.height+this.config.menuOffset)<f.y-this.config.menuOffset?-((f.y-a.top+d.height)-b.height+this.config.menuOffset):-(f.y-this.config.menuOffset)):this.config.menuTopAlign)+"px"};if(this.ie6){c.ul.down("iframe").setStyle(d)}c.ul.setStyle(g).addClassName(this.config.showMenuClassName)}},showMenu:function(c){if(this.config.trigger=="contextmenu"&&Prototype.Browser.Opera&&!c.altKey){return}c.stop();if(!this.menu||this.config.dynamic){this.buildMenu(c)}else{this.menu.select("ul").invoke("removeClassName",this.config.showMenuClassName)}var d=this.menu.getDimensions(),b=document.viewport.getDimensions(),a=document.viewport.getScrollOffsets(),e={left:(((c.pageX+d.width+this.config.menuOffset)>b.width)?(b.width-d.width-this.config.menuOffset):c.pageX)+"px",top:(((c.pageY-a.top+d.height)>b.height&&(c.pageY-a.top)>d.height)?(c.pageY-d.height):c.pageY)+"px"};if(this.ie6){this.menu.down("iframe").setStyle(d)}$(this.menu).setStyle(e).show();this.event=c;$$("."+this.config.activeClassName).invoke("removeClassName",this.config.activeClassName);this.event.element().addClassName(this.config.activeClassName);Event.observe(document,"click",this.hideMenuBind)},hideMenu:function(){this.menu.select("ul").invoke("removeClassName",this.config.showMenuClassName);this.menu.hide();this.event.element().removeClassName(this.config.activeClassName);Event.stopObserving(document,"click",this.hideMenuBind)},action:function(){var a=$(arguments[0].target).match(this.config.actionArgs)?$(arguments[0].target).id.split("-"):$(arguments[0].target).up(this.config.actionArgs).id.split("-"),d=new Hash();d.set(this.config.actionName,$(arguments[1].li)._name);d.set(a[0],a[1]);this.config.actionBaseHref=this.config.actionBaseHref.unescapeHTML();if(this.config.actionBaseHref.include("?")){var c=this.config.actionBaseHref.toQueryParams();d.update(c);var b=this.config.actionBaseHref.replace($H(c).toQueryString(),"")+d.toQueryString()}else{var b=this.config.actionBaseHref+"?"+d.toQueryString()}window.location=b}});Element.addMethods({appendText:function(a,b){a.appendChild(document.createTextNode(b));return $(a)}});